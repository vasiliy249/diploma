# Интроспекционный анализ динамики оперативной памяти операционных систем семейства Windows NT

# Введение

## Актуальность работы

В связи с прогрессом в области информационных технологий наблюдается рост программного и 
аппаратного обеспечения, позволяющего решать многие задачи в различных сферах деятельности 
человека. Люди стали активно использовать платёжные системы, WEB-ресурсы для передачи данных, 
запоминающее устройства для записи и хранения важной информации и т.п. Всё это – заслуга 
компьютерных технологий. Однако в настоящее время активная интеграция современных 
информационных технологий практически во все области человеческой деятельности привела 
к тому, что с помощью программно-аппаратных средств и систем совершаются разного рода 
преступления (например, кража, мошенничество, лжепредпринимательство и др.). Кроме того, 
современные технологии также могут использоваться с целью фальсификации 
платежных документов, хищения наличных и безналичных денежных средств путем 
перечисления на фиктивные счета, вторичного получения уже произведенных выплат, 
продажи секретной информации и т.п.

Преступления, совершаемые с использованием компьютерных технологий, представляют 
серьезную угрозу для любой располагающей программно-аппаратным обеспечением организации. 
Такого рода преступления принято называть компьютерными преступлениями [1]. 
Наука, занимающаяся исследованием таких преступлений, называется компьютерной 
криминалистикой (иначе форензикой) [1]. Сам термин, форензика, произошёл от 
латинского «foren», что значит «речь перед форумом». В русский язык это слово 
пришло из английского. Полная форма этого термина на английском языке звучит 
следующим образом: «computer forensic science», что дословно означает 
«наука о компьютерной криминалистике». Согласно определению, форензика – 
это прикладная наука о раскрытии преступлений, связанных с компьютерной информацией, 
об исследовании цифровых доказательств, методах поиска, получения и закрепления таких 
доказательств, о применяемых для этого технических средствах [1].

Данная область криминалистики полноценно существует в развитых странах: издан ряд научных 
трудов (Windows Forensic Analysis Toolkit, Harlan Carvey; The Art of Memory Forensics, 
Michael Hale Ligh, Andrew Case, Jamie Levy, AAron Walters и т. д.) имеются учебные курсы, 
существуют официальные рекомендации, которым необходимо следовать при криминалистической 
экспертизе.

В других странах форензика лишь начинает развиваться. К сожалению, Россия относится 
как раз к таковым, не смотря на то, что в ней масса компьютерных специалистов высокого 
уровня. Например, одним из показателей является серийный выпуск программно-аппаратных 
комплексов, специализированных для сбора, обработки и анализа доказательств, 
для обеспечения целостности данных при изъятии и исследовании 
(например, PCI карта Tribble, проект WindowsSCOPE, LiMe и т. п.). 
В России такого рода обеспечение только начинает производиться, всё чаще закупается. 
Данное обстоятельство объясняется слаборазвитой научной платформой и 
отсутствием достаточного количества публикаций по данному направлению, отсутствием 
проработанной системы законов в компьютерно-криминалистической области 
(её заменяют небольшое количество статей). Также возможна причина в системе 
образования или наличии других, более оплачиваемых, IT-областей науки. 
Так или иначе, Россия пока отстаёт в этом направлении от других развитых стран.

Одной из задач компьютерной криминалистики является сбор и анализ информации, 
хранящейся на компьютере [1]. Сбор осуществляется с помощью класса методов снятия 
образов памяти - (на англ. - memory acquisition) [2]. Анализ и извлечение необходимых
 данных производится соответствующими методами карвинга данных (на англ. data carving) [3].  

Следует отметить, что информация на компьютере может храниться в трёх местах:

* кэш-память процессора, 
* оперативная память компьютера,
* внешняя память компьютера.

В связи с тем, что первый тип памяти является специфичным и не адресуемым 
для программиста, то в данной работе он не рассматривается. 

В данной работе рассматривается класс методов анализа оперативной памяти. 
Один из конкретных методов этого класса интегрирован с технологией виртуализации [4], 
этот метод позволяет проанализировать оперативную память виртуальных машин в динамике. 
Основной задачей этой работы является изучение и применение данного способа для 
операционных систем семейства Windows. Данный выбор обусловлен тем, что эти 
операционные системы популярны среди большинства пользователей. 

Как упоминалось выше, существует множество инструментов для такого рода задач, 
но, к сожалению, у них есть свои недостатки, такие как большая стоимость известных 
решений, отсутствие открытого исходного кода и, как следствие, возможности в модификации 
каких-либо компонентов программы для определённых задач, платная техническая 
поддержка и т. п.

## Цель работы

Целью данной работы является разработка криминалистического программного комплекса, 
интегрированного с платформами виртуализации, который позволит производить неинвазивный 
анализ динамики оперативной памяти гостевых операционных систем.

## Задачи работы

Для достижения поставленной цели был сформулирован и решен ряд задач: 

* изучение известных методов и подходов при анализе образов оперативной памяти;
* выбор и развёртывание подходящей системы виртуализации (гипервизора);
* исследование устройства физического и виртуального пространства памяти в 
операционных системах Windows 7 x86_64;
* разработка архитектуры программного комплекса.

#Глава 1.

## 1.1 Обзор существующих технологий

Существует множество аппаратных и программных средств для снятия и анализа 
необходимых данных. К ним относятся Belkasoft RAM Capturer, Volatility Framework, 
MANDIANT Memoryze, Guidance Software WinEn, FTK Imager, Moonsols DumpIt. 
Среди них есть прекрасные инструменты, решающие определённые задачи. 
Но эти средства имеют ряд недостатков. Большинство из них имеют высокую стоимость 
и закрытый исходный код, а основной недостаток заключается в их инвазивности, т.е. 
влиянии на исходные данные. При использовании данных инструментов возникает 
необходимость во внедрении собственного резидентного кода в оперативную память машины, 
что может в разной степени модифицировать исследуемую память. Это недопустимо 
с точки зрения корректности проведения компьютерно-криминалистической экспертизы. 
Поэтому возникает необходимость в создании архитектуры и дальнейшей разработки 
программного комплекса, который будет использовать метод неинвазивного анализа 
оперативной памяти. В данной работе будет уделено внимание созданию такого 
криминалистического программного инструмента, интегрированного с платформами 
виртуализации (прежде всего Qemu/KVM).


## 1.2 Технология. Теоретическая часть.

Перед непосредственным проектированием программного комплекса следует изучить 
необходимую информацию по устройству оперативной памяти в операционных системах Windows 7.

### Виртуальная и физическая память 

В данной работе будут использоваться два термина – виртуальная память и физическая память. 
Под физической памятью подразумевается оперативная память, которая представляет 
упорядоченный набор однобайтовых ячеек, каждая из которых имеет свой уникальный адрес. 
Совокупность адресов в физической памяти, используемых для идентификации хранимых в 
памяти данных, называется физическим адресным пространством. Виртуальная память – это 
абстрактное хранилище, созданное самой операционной системой для удобства управления
физической памятью. Виртуальная память позволяет программам считать, что им предоставлена 
неограниченная память и непрерывное адресное пространство.

### Преобразование виртуального адреса в физический

Виртуальная память в операционной системе Windows имеет сегментно-страничную 
организацию. Адресное пространство процесса представляется в виде набора сегментов 
переменного размера. Каждый сегмент делится на страницы – блоки фиксированного размера, 
при этом физическая память делится на блоки того же размера – фреймы. [5]

При анализе оперативной памяти необходимо уметь восстанавливать адресное пространство 
процесса, то есть провести преобразование известных виртуальных адресов в соответствующие 
им физические, тем самым получив данные всех страниц виртуальной памяти из кадров (фреймов) 
оперативной памяти.

Трансляция виртуального адреса в физический производится посредством четырёхуровневой 
табличной структуры преобразований. Виртуальный адрес разделен на пять частей: селектор 
четвертого уровня отображения страницы, селектор указателя каталога страниц, селектор 
таблицы страниц, селектор записи таблицы страниц и байтовое смещение. При помощи этих 
указателей осуществляется преобразование адресов. [6]

### Поиск процессов

Анализ дампа ОП Windows 7 предполагает поиск активных процессов. Каждый процесс в ОП 
представлен как объект структуры _ERPOCESS, хранящейся в адресном пространстве ядра. 
У данной структуры есть множество свойств и подструктур, первая из них – подструктура 
_KPROCESS – блок управления процессом, он начинается с субструктуры _DISPATCHER_HEADER. 
Значения некоторых полей, которые она содержит, постоянны для всех процессов. 
Такими полями будут являться Type и Size. Таким образом, поиск процессов в оперативной 
памяти сводится к поиску соответствующего байтового паттерна в адресном 
пространстве ядра.

### Поиск информации о реестре

Реестр Windows - иерархически построенная база данных параметров и настроек в 
большинстве операционных систем Microsoft Windows. Реестр содержит информацию и 
настройки для аппаратного обеспечения, программного обеспечения, профилей пользователей, 
предустановки [7]. В памяти реестр представляет собой набор отдельных файлов, которые 
называются хайвами (на англ. Hive). Каждый хайв содержит дерево реестра и представлен в 
памяти структурой _CMHIVE. В данной структуре содержится множество метаданных, необходимых 
для анализа. Для поиска данной структуры можно воспользоваться выше упомянутым методом 
поиска соответствующего байтового паттерна в адресном пространстве ядра. 
В данном случае байтовым паттерном будет сигнатура, с которой начинается 
подструктура _HHIVE структуры _CMHIVE. [8]

### Анализ сетевых соединений

Информация о сетевых соединениях включает в себя идентификатор процесса, время создания, 
установленные соединения, локальный и удаленные адреса, локальный и удаленный порты. 
Извлечение информации о сетевых соединениях осуществляется аналогично описанным выше 
случаям – поиск сигнатуры структуры TCB и TcpEndpoint. [9]

## Литература

1. Федотов Н.Н., «Форензика – компьютерная криминалистика», 2007

2. Michael Hale Ligh, Andrew Case, Jamie Levy, AAron Walters, «The Art of Memory Forensics: Detecting Malware and Threats in Windows, Linux, and Mac Memory», 2014

3. Digambar Povar, V. K. Bhadran, «Forensic Data Carving», 2011

4. «Обзор методов виртуализации, архитектур и реализаций» www.ibm.com/developerworks/ru/library/l-linuxvirt/index.html

5. Виртуальное адресное пространство процесса http://www.intuit.ru/studies/courses/1089/217/lecture/5601

6. Russinovich M., Solomon D., Windows Internals, Fifth Edition ("Внутреннее устройство Windows, часть вторая, шестое издание")

7. Реестр Windows https://ru.wikipedia.org/wiki/Реестр_Windows

8. Russinovich M., Solomon D., Windows Internals, Fifth Edition ("Внутреннее устройство Windows, часть вторая, шестое издание")

9. A Method to Analyze Memory Images of 64-bit Windows 8, Lijuan. Xu, Lianhai. Wang, Shuhui. Zhang, Hengjian. Li


